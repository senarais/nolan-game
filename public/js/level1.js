const dialogues = {
  1: [
    { name: "Narrator", text: "Bob pulls Alice into a warm hug, his arms wrapping around her fully.", img: "" },
    { name: "Bob", text: "God, I’ve missed you all day, Alice.", img: "/img/nolan.png" },
    { name: "Narrator", text: "He kisses her forehead, stroking her hair.", img: "" },
    { name: "Alice", text: "I missed you too.", img: "/img/eliza.png" }
  ],

  2: [
    { name: "Narrator", text: "As they sit together, Bob notices Alice’s outfit—an oversized shirt, clearly his, hanging loosely on her body.", img: "" },
    { name: "Bob", text: "Wait… is that my shirt you’re stealing?", img: "/img/nolan.png" },
    { name: "Alice", text: "Mmhmm… I told you, it’s comfy. Plus, it smells like you.", img: "/img/eliza.png" },
    { name: "Narrator", text: "Bob chuckles, brushing a strand of hair from her face, his eyes lingering on the shirt.", img: "" },
    { name: "Narrator", text: "He starts unbuttoning it slowly, kissing the skin revealed with each button undone.", img: "" },
    { name: "Alice", text: "You’re really taking your time…", img: "/img/eliza.png" },
    { name: "Bob", text: "Because every part of you deserves attention.", img: "/img/nolan.png" },
    { name: "Narrator", text: "The shirt slides off her shoulders naturally, Bob’s lips and hands following gently, making Alice feel both safe and wanted.", img: "" },
    { name: "Alice", text: "You make me feel so… adored.", img: "/img/eliza.png" },
    { name: "Bob", text: "That’s exactly what you are.", img: "/img/nolan.png" }
  ],

  3: [
    { name: "Narrator", text: "Now closer, Bob pulls Alice onto his lap, his hands running gently along her back.", img: "" },
    { name: "Alice", text: "Mmm… you know exactly how to touch me.", img: "/img/eliza.png" },
    { name: "Bob", text: "I’ve had all day to think about it.", img: "/img/nolan.png" },
    { name: "Narrator", text: "He kisses along her neck slowly, savoring every reaction from her body.", img: "" },
    { name: "Narrator", text: "The room is softly lit, wrapping them in warmth. Bob leans back slightly, letting his eyes travel over Alice’s form, but his hands never leave her body.", img: "" },
    { name: "Alice", text: "Don’t look at me like that… it makes me nervous.", img: "/img/eliza.png" },
    { name: "Bob", text: "Not nervous… loved. You’re beautiful, Alice. Every curve, every line… it’s all perfect to me.", img: "/img/nolan.png" },
    { name: "Narrator", text: "He trails his fingers slowly along her arm, down her side, then pauses to kiss the spot tenderly. Alice shivers, but then relaxes into him.", img: "" },
    { name: "Alice", text: "You make me feel… safe when you say it like that.", img: "/img/eliza.png" },
    { name: "Bob", text: "That’s because I’m not just looking. I’m appreciating. You’re my everything.", img: "/img/nolan.png" }
  ],

  4: [
    { name: "Narrator", text: "Bob lays Alice gently on the couch, his body hovering above hers as he kisses her deeply. His hand trails from her waist down to her thigh.", img: "" },
    { name: "Alice", text: "Mmm… you’re driving me crazy.", img: "/img/eliza.png" },
    { name: "Bob", text: "That’s the plan.", img: "/img/nolan.png" },
    { name: "Narrator", text: "His fingers slowly stroke along the outside of her thigh, then shift inward, teasing closer and closer but never touching her center just yet.", img: "" },
    { name: "Alice", text: "You’re teasing me…", img: "/img/eliza.png" },
    { name: "Bob", text: "I want to enjoy every second of you.", img: "/img/nolan.png" },
    { name: "Narrator", text: "His lips stay busy at her neck, sucking lightly as his hand brushes over the fabric between her legs, applying just enough pressure to make her gasp.", img: "" },
    { name: "Alice", text: "Ahh… Bob…", img: "/img/eliza.png" },
    { name: "Bob", text: "Shh… I love how your body reacts to me.", img: "/img/nolan.png" },
    { name: "Narrator", text: "He gently traces the edge of her underwear with his fingers, pausing to let her breathe, then slips his hand inside, caressing her warmth slowly.", img: "" },
    { name: "Alice", text: "Oh my god… that feels so good.", img: "/img/eliza.png" },
    { name: "Bob", text: "I want to make you feel even better.", img: "/img/nolan.png" },
    { name: "Narrator", text: "His fingers begin slow, teasing circles, avoiding the most sensitive spot at first. Alice squirms beneath him, her breaths becoming sharper.", img: "" },
    { name: "Alice", text: "Please… don’t stop.", img: "/img/eliza.png" },
    { name: "Bob", text: "I’m not going anywhere.", img: "/img/nolan.png" },
    { name: "Narrator", text: "Finally, his touch finds her most sensitive spot, gentle but deliberate. Alice’s back arches as she moans, her body giving in completely to him.", img: "" }
  ],

  5: [
    { name: "Narrator", text: "Bob focuses on her body with rhythm, watching every reaction. He keeps kissing, touching, whispering between breaths.", img: "" },
    { name: "Bob", text: "I can feel you getting so close…", img: "/img/nolan.png" },
    { name: "Alice", text: "Yes… don’t stop, Bob…", img: "/img/eliza.png" },
    { name: "Bob", text: "I want you to enjoy every second of this.", img: "/img/nolan.png" },
    { name: "Alice", text: "I… I’m almost…", img: "/img/eliza.png" },
    { name: "Bob", text: "That’s it… let go for me, Alice. I’ve got you.", img: "/img/nolan.png" },
    { name: "Alice", text: "Bob… I can’t hold it…", img: "/img/eliza.png" },
    { name: "Bob", text: "Come on, baby… give it all to me. I want to see you lose control.", img: "/img/nolan.png" },
    { name: "Narrator", text: "Alice cries out as she peaks, clutching Bob tightly.", img: "" },
    { name: "Alice", text: "Bob!", img: "/img/eliza.png" }
  ],

  6: [
    { name: "Narrator", text: "Bob holds Alice tight, stroking her hair, kissing her forehead gently.", img: "" },
    { name: "Bob", text: "That’s it… you were incredible, Alice.", img: "/img/nolan.png" },
    { name: "Alice", text: "I love being with you like this…", img: "/img/eliza.png" },
    { name: "Bob", text: "And I’ll never get tired of making you feel this way.", img: "/img/nolan.png" },
    { name: "Narrator", text: "Bob wraps her in his arms, keeping her close until her breathing slows.", img: "" }
  ],

  7: [
    { name: "Narrator", text: "Later, as they lay in bed together, the room quiet and warm.", img: "" },
    { name: "Alice", text: "You always know how to make me feel special, Bob.", img: "/img/eliza.png" },
    { name: "Bob", text: "Because you are special. You’re everything to me.", img: "/img/nolan.png" },
    { name: "Alice", text: "Promise we’ll always be like this?", img: "/img/eliza.png" },
    { name: "Bob", text: "Always. No matter what.", img: "/img/nolan.png" },
    { name: "Narrator", text: "Alice smiles, resting her head on his chest as they drift into comfortable silence.", img: "" }
  ]
};




let dialogueIndex = 0;
const textElement = document.querySelector(".text");
const nameElement = document.querySelector(".name");
const imgElement = document.querySelector(".textbox img");
const textboxElement = document.querySelector(".textbox-name");
const textBox = document.querySelector(".textbox");

let currentDialogue = 1;
let isTyping = false;
let typingTimeout;
let fullText = "";

function textTypingEffect(element, text, i = 0) {
  isTyping = true;
  fullText = text;

  return new Promise((resolve) => {
    const textSound = new Audio("/audio/text-blip.mp3");
    document.addEventListener("click", nextDialogue);
    document.addEventListener("keydown", nextDialogue);

    if (i === 0) {
      element.textContent = ""; // clear old text
    }

    element.textContent += text[i];
    textSound.volume = 0.3;
    textSound.play();

    if (i === text.length - 1) {
      isTyping = false;
      resolve();
      return;
    }

    typingTimeout = setTimeout(() => {
      textTypingEffect(element, text, i + 1).then(resolve);
    }, 20);
  });
}

async function showDialogue() {
  if (dialogueIndex < dialogues[currentDialogue].length) {
    const dialogueDisplay = dialogues[currentDialogue][dialogueIndex].text;
    const nameDisplay = dialogues[currentDialogue][dialogueIndex].name;
    const imgDisplay = dialogues[currentDialogue][dialogueIndex].img;
    
    if (nameDisplay === "Narrator"){
      textboxElement.classList.add("hidden");
      imgElement.src = imgDisplay;
    } else {
      textboxElement.classList.remove("hidden");
      nameElement.textContent = nameDisplay;
      imgElement.src = imgDisplay;
    }

    await textTypingEffect(textElement, dialogueDisplay);
  } else {
    dialogueIndex = 0;
    currentDialogue++;
    showDialogue();
  }
}

// First line
textBox.classList.add("hidden");
// setTimeout(() => {
//   textBox.classList.remove("hidden");
//   showDialogue();
// }, 2000);

function nextDialogue(event) {
  if (event.type === "keydown") {
    if (event.code !== "Space" && event.code !== "Enter") {
      return; // abaikan tombol lain
    }
  }
  document.removeEventListener("click", nextDialogue);
  document.removeEventListener("keydown", nextDialogue);
  skipDialogue();
}

function skipDialogue() {
  if (isTyping) {
    // kalau masih ngetik → langsung tampilkan teks penuh
    clearTimeout(typingTimeout);
    textElement.textContent = fullText;
    isTyping = false;

    // pasang lagi listener supaya bisa lanjut
    document.addEventListener("click", nextDialogue);
    document.addEventListener("keydown", nextDialogue);
  } else {
    // kalau sudah penuh → lanjut ke berikutnya
    dialogueIndex++;
    showDialogue();
  }
}




const questions = {
  1: {
    question: "What is the capital of France?",
    answers: [
      "A. Madrid",
      "B. Berlin",
      "C. Paris",
      "D. Rome"
    ],
    rightAnswer: "C"
  },

  2: {
    question: "Which planet is known as the Red Planet?",
    answers: [
      "A. Venus",
      "B. Mars",
      "C. Jupiter",
      "D. Saturn"
    ],
    rightAnswer: "B"
  },

  3: {
    question: "Who wrote 'Romeo and Juliet'?",
    answers: [
      "A. Charles Dickens",
      "B. William Shakespeare",
      "C. Mark Twain",
      "D. Jane Austen"
    ],
    rightAnswer: "B"
  },

  4: {
    question: "Which is the largest ocean on Earth?",
    answers: [
      "A. Atlantic Ocean",
      "B. Indian Ocean",
      "C. Arctic Ocean",
      "D. Pacific Ocean"
    ],
    rightAnswer: "D"
  }
};

let currentQuestion = 1;
let questionCurrentTime = 10;
let questionTimeout;
const timeText = document.querySelector(".clock-icon p");
const answerElement = document.querySelectorAll(".question-container button");
const clockTick = new Audio("/audio/clock-tick.mp3");


function showQuestion() {
  const questionElement = document.querySelector(".question p");
  const questionText = questions[currentQuestion].question;
  const answerText = questions[currentQuestion].answers;
 

  for (let i = 0; i < answerText.length; i++) {
    answerElement[i].textContent = answerText[i];
  }

  answerElement.forEach(button => {
    button.addEventListener("click", handleButton);
  });

  timeText.textContent = questionCurrentTime;
  questionElement.textContent = questionText;
  questionTimeout = setTimeout(() => {
    if (questionCurrentTime == 0) {
      checkAnswer();
    } 
    else if (questionCurrentTime > 0) {
      questionCurrentTime--;
      timeText.textContent = questionCurrentTime;
      clockTick.play();
      showQuestion();
    }
  }, 1000);
  document.querySelector(".question").classList.remove("hidden");
} 




function checkAnswer(answer) {
  const rightAnswer = questions[currentQuestion].rightAnswer;

  if (!answer) {
    // berarti waktu habis / gak ada jawaban
    const wrongAudio = new Audio("/audio/wrong-answer.mp3");
    wrongAudio.play();

    clearTimeout(questionTimeout);
    questionCurrentTime = 10;
    timeText.textContent = questionCurrentTime;
    answerElement.forEach(button => {
      button.removeEventListener("click", handleButton);
    });
    clockTick.pause();
    clockTick.currentTime = 0;

    setTimeout(() => {
      showQuestion();
    }, 2000);

    return; // stop supaya gak error
  }

  const userAnswer = answer.value;
  const answerContainer = answer.parentElement;

  if (userAnswer !== rightAnswer) {
    answerContainer.style.backgroundColor = "#ff5757";
    const wrongAudio = new Audio("/audio/wrong-answer.mp3");
    wrongAudio.play();

    clearTimeout(questionTimeout);
    questionCurrentTime = 10;
    timeText.textContent = questionCurrentTime;
    answerElement.forEach(button => {
      button.removeEventListener("click", handleButton);
    });
    clockTick.pause();
    clockTick.currentTime = 0;
    setTimeout(() => {
      answerContainer.style.backgroundColor = "";
      showQuestion();
    }, 2000);
  }

  if (rightAnswer === userAnswer) {
    answerContainer.style.backgroundColor = "#48ae51";
    const correctAudio = new Audio("/audio/right-answer.mp3");
    correctAudio.play();
    clearTimeout(questionTimeout);
    questionCurrentTime = 10;
    timeText.textContent = questionCurrentTime;
    answerElement.forEach(button => {
      button.removeEventListener("click", handleButton);
    });
    clockTick.pause();
    clockTick.currentTime = 0;
    currentQuestion++;
    setTimeout(() => {
      answerContainer.style.backgroundColor = "";
      showQuestion();
    }, 2000);

  }
}

function startBattle() {
  const battle = document.querySelector(".battleStart");
  const battleStartAudio = new Audio("/audio/battle-start.mp3");

  battleStartAudio.play();

  battle.classList.remove("hidden"); // reset animasi kalau sudah ada
  battle.classList.remove("battleTransition"); // reset animasi kalau sudah ada
  void battle.offsetWidth;                     // hack biar animasi bisa replay
  battle.classList.add("battleTransition");

  setTimeout(() => {
    battle.classList.add("hidden");
    showQuestion();
  }, 2000);
} 
setTimeout(() => {
  startBattle();
}, 2000);

function handleButton() {
  checkAnswer(this);
}